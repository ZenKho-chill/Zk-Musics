import {
  GuildMember,
  PartialGuildMember,
  Presence,
  EmbedBuilder,
  AuditLogEvent,
} from "discord.js";
import { isEventEnabled, getModLogChannel } from "../ModLogEventUtils.js";
import { Manager } from "../../manager.js";

export class MemberEventsHandler {
  private client: Manager;

  constructor(client: Manager) {
    this.client = client;
    this.init();
  }

  private init() {
    this.client.on("guildMemberAdd", this.handleGuildMemberAdd.bind(this));
    this.client.on(
      "guildMemberRemove",
      this.handleGuildMemberRemove.bind(this)
    );
    this.client.on(
      "guildMemberUpdate",
      this.handleGuildMemberUpdate.bind(this)
    );
    this.client.on("guildMemberBoost", this.handleGuildMemberBoost.bind(this));
    this.client.on("presenceUpdate", this.handlePresenceUpdate.bind(this));
  }

  // X·ª≠ l√Ω c·∫≠p nh·∫≠t tr·∫°ng th√°i online (presence)
  private async handlePresenceUpdate(
    oldPresence: Presence | null,
    newPresence: Presence
  ) {
    const member = newPresence.member as GuildMember;
    if (
      !member ||
      !(await isEventEnabled(
        member.guild.id,
        "guildMemberOnlineStatusUpdate",
        this.client.db
      ))
    )
      return;

    const logChannel = await getModLogChannel(member.guild.id, this.client);
    if (!logChannel) return;

    const oldStatus = oldPresence?.status || "offline"; // m·∫∑c ƒë·ªãnh 'offline' n·∫øu kh√¥ng c√≥ presence tr∆∞·ªõc
    const newStatus = newPresence.status;

    if (oldStatus !== newStatus) {
      await logChannel.send({
        embeds: [
          new EmbedBuilder()
            .setColor(0x1e90ff)
            .setTitle("üü¢ Tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi")
            .setDescription(
              `**Th√†nh vi√™n:** <@${member.id}> ƒë√£ thay ƒë·ªïi tr·∫°ng th√°i t·ª´ **${oldStatus}** sang **${newStatus}**.`
            )
            .setTimestamp(new Date()),
        ],
      });
    }
  }

  // X·ª≠ l√Ω s·ª± ki·ªán th√†nh vi√™n tham gia
  private async handleGuildMemberAdd(member: GuildMember | PartialGuildMember) {
    if (
      !(await isEventEnabled(member.guild.id, "guildMemberAdd", this.client.db))
    )
      return;

    const channel = await getModLogChannel(member.guild.id, this.client);
    if (!channel) return;

    const memberInfo =
      member instanceof GuildMember
        ? `<@${member.id}> (${member.id})`
        : `${member.user.tag}`;
    const accountCreationTimestamp = `<t:${Math.floor(
      member.user.createdTimestamp / 1000
    )}:F>`;
    const accountCreationRelative = `<t:${Math.floor(
      member.user.createdTimestamp / 1000
    )}:R>`;
    await channel.send({
      embeds: [
        new EmbedBuilder()
          .setColor(0x00ff00)
          .setAuthor({
            name: member.user.tag,
            iconURL: member.user.displayAvatarURL(),
          })
          .setThumbnail(
            member.user.displayAvatarURL({ size: 512 }) ||
              this.client.user?.displayAvatarURL({ size: 512 })
          )
          .setDescription(`üì• <@${member.id}> **ƒë√£ tham gia m√°y ch·ªß.**`)
          .addFields(
            {
              name: "T·∫°o t√†i kho·∫£n",
              value: `${accountCreationTimestamp} (${accountCreationRelative})`,
              inline: false,
            },
            {
              name: "C√°c ID",
              value: `> ${memberInfo}`,
              inline: false,
            }
          )
          .setFooter({
            text: this.client.user?.username || "Kh√¥ng r√µ",
            iconURL:
              this.client.user?.displayAvatarURL() ||
              "https://raw.githubusercontent.com/ZenKho-chill/zkcard/main/build/structures/images/avatar.png",
          })
          .setTimestamp(new Date()),
      ],
    });
  }

  // X·ª≠ l√Ω s·ª± ki·ªán th√†nh vi√™n r·ªùi
  private async handleGuildMemberRemove(
    member: GuildMember | PartialGuildMember
  ) {
    if (
      !(await isEventEnabled(
        member.guild.id,
        "guildMemberRemove",
        this.client.db
      ))
    )
      return;

    const channel = await getModLogChannel(member.guild.id, this.client);
    if (!channel) return;

    const memberInfo =
      member instanceof GuildMember
        ? `<@${member.id}> (${member.id})`
        : `${member.user.tag}`;

    await channel.send({
      embeds: [
        new EmbedBuilder()
          .setColor(0xff4500)
          .setAuthor({
            name: member.user.tag,
            iconURL: member.user.displayAvatarURL(),
          })
          .setThumbnail(
            member.user.displayAvatarURL({ size: 512 }) ||
              this.client.user?.displayAvatarURL({ size: 512 })
          )
          .setDescription(`üì§ <@${member.id}> **ƒë√£ r·ªùi m√°y ch·ªß.**`)
          .addFields({
            name: "C√°c ID",
            value: `> ${memberInfo}`,
            inline: true,
          })
          .setFooter({
            text: this.client.user?.username || "Kh√¥ng r√µ",
            iconURL:
              this.client.user?.displayAvatarURL() ||
              "https://raw.githubusercontent.com/ZenKho-chill/zkcard/main/build/structures/images/avatar.png",
          })
          .setTimestamp(new Date()),
      ],
    });
  }

  // X·ª≠ l√Ω s·ª± ki·ªán c·∫≠p nh·∫≠t th√†nh vi√™n
  private async handleGuildMemberUpdate(
    oldMember: GuildMember | PartialGuildMember,
    newMember: GuildMember
  ) {
    if (
      !(await isEventEnabled(
        newMember.guild.id,
        "guildMemberUpdate",
        this.client.db
      ))
    )
      return;

    const logChannel = await getModLogChannel(newMember.guild.id, this.client);
    if (!logChannel) return;

    // Theo d√µi thay ƒë·ªïi nickname
    if (oldMember.nickname !== newMember.nickname) {
      await logChannel.send({
        embeds: [
          new EmbedBuilder()
            .setColor(0x1e90ff)
            .setAuthor({
              name: newMember.user.tag,
              iconURL: newMember.user.displayAvatarURL(),
            })
            .setThumbnail(
              newMember.user.displayAvatarURL({ size: 512 }) || null
            )
            .setDescription(
              `üî¢ **Nickname ƒë√£ thay ƒë·ªïi**\n ${
                oldMember.nickname || oldMember.user.username
              } ‚û°Ô∏è ${newMember.nickname || "Kh√¥ng c√≥"}`
            )
            .addFields({
              name: "C√°c ID",
              value: `> <@${newMember.id}> (${newMember.id})`,
              inline: true,
            })
            .setFooter({
              text: this.client.user.username || this.client.user.tag,
              iconURL: this.client.user?.displayAvatarURL(),
            })
            .setTimestamp(new Date()),
        ],
      });
    }

    // Theo d√µi thay ƒë·ªïi role (th√™m / g·ª°)
    const oldRoles = oldMember.roles.cache;
    const newRoles = newMember.roles.cache;

    const addedRoles = newRoles.filter((role) => !oldRoles.has(role.id));
    const removedRoles = oldRoles.filter((role) => !newRoles.has(role.id));

    // Fetch audit logs for role updates
    const auditLogs = await newMember.guild.fetchAuditLogs({
      limit: 1,
      type: AuditLogEvent.MemberRoleUpdate,
    });
    const entry = auditLogs.entries.first();
    const executor = entry?.executor;

    // N·∫øu c√≥ role ƒë∆∞·ª£c th√™m,
    if (addedRoles.size > 0) {
      await logChannel.send({
        embeds: [
          new EmbedBuilder()
            .setColor(0x32cd32)
            .setAuthor({
              name: newMember.user.tag,
              iconURL: newMember.user.displayAvatarURL(),
            })
            .setThumbnail(
              newMember.user.displayAvatarURL({ size: 512 }) || null
            )
            .setDescription(
              `**ƒê√£ th√™m role**\n+ ${addedRoles
                .map((role) => `<@&${role.id}>`)
                .join("\n+ ")}**`
            )
            .addFields({
              name: "C√°c ID",
              value: `
                > <@${newMember.id}> (${newMember.id})
                > <@${executor?.id}> (${executor?.id})`,
              inline: true,
            })
            .setFooter({
              text: this.client.user.username || this.client.user.tag,
              iconURL: this.client.user?.displayAvatarURL(),
            })
            .setTimestamp(new Date()),
        ],
      });
    }

    // N·∫øu c√≥ role b·ªã g·ª°
    if (removedRoles.size > 0) {
      await logChannel.send({
        embeds: [
          new EmbedBuilder()
            .setColor(0xff4500)
            .setAuthor({
              name: newMember.user.username,
              iconURL: newMember.user.displayAvatarURL(),
            })
            .setThumbnail(
              newMember.user.displayAvatarURL({ size: 512 }) || null
            )
            .setDescription(
              `**ƒê√£ g·ª° role**\n‚Äì ${removedRoles
                .map((role) => `<@&${role.id}>`)
                .join("\n- ")}**`
            )
            .addFields({
              name: "C√°c ID",
              value: `
                > <@${newMember.id}> (${newMember.id})
                > <@${executor?.id}> (${executor?.id})`,
              inline: true,
            })
            .setFooter({
              text: this.client.user.username || this.client.user.tag,
              iconURL: this.client.user?.displayAvatarURL(),
            })
            .setTimestamp(new Date()),
        ],
      });
    }
  }

  // X·ª≠ l√Ω s·ª± ki·ªán boost m√°y ch·ªß
  private async handleGuildMemberBoost(member: GuildMember) {
    if (
      !(await isEventEnabled(
        member.guild.id,
        "guildMemberBoost",
        this.client.db
      ))
    )
      return;

    const logChannel = await getModLogChannel(member.guild.id, this.client);
    if (!logChannel) return;

    await logChannel.send({
      embeds: [
        new EmbedBuilder()
          .setAuthor({
            name: member.user.tag,
            iconURL: member.user.displayAvatarURL(),
          })
          .setThumbnail(member.user.displayAvatarURL({ size: 512 }) || null)
          .setColor(0xff69b4)
          .setTitle("üíé M√°y ch·ªß ƒë√£ ƒë∆∞·ª£c boost")
          .setDescription(
            `> **<@${member.id}> (${member.user.id}) ƒë√£ boost m√°y ch·ªß.**`
          )
          .setFooter({
            text: this.client.user.username || this.client.user.tag,
            iconURL: this.client.user?.displayAvatarURL(),
          })
          .setTimestamp(new Date()),
      ],
    });
  }
}
